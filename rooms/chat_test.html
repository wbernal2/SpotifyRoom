<!DOCTYPE html>
<html>
<head>
    <title>Chat Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 20px;
            background: #121212;
            color: white;
        }
        #messages { 
            border: 1px solid #333; 
            height: 300px; 
            overflow-y: auto; 
            padding: 10px; 
            margin: 10px 0;
            background: #1e1e1e;
        }
        input, button { 
            padding: 10px; 
            margin: 5px;
            background: #333;
            color: white;
            border: 1px solid #555;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #1db954;
            background: rgba(29, 185, 84, 0.1);
        }
        .status {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Chat Test for Room: OEOEYQ</h1>
    <div>
        Status: <span id="status" class="status">Disconnected</span>
    </div>
    <div id="messages"></div>
    <div>
        <input type="text" id="nameInput" placeholder="Your name" value="Test User">
        <input type="text" id="messageInput" placeholder="Type your message">
        <button onclick="sendMessage()">Send</button>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>

    <script>
        let socket = null;
        const roomCode = 'OEOEYQ';
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }
        
        function addMessage(name, text, isSystem = false) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isSystem ? 'status' : 'message';
            messageDiv.innerHTML = isSystem ? text : `<strong>${name}:</strong> ${text}`;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function connect() {
            if (socket) {
                socket.close();
            }
            
            const wsUrl = `ws://localhost:8000/ws/chat/${roomCode}/`;
            console.log('Connecting to:', wsUrl);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('Connected to chat');
                updateStatus('Connected');
                addMessage('', 'Connected to chat', true);
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                
                if (data.type === 'chat.message') {
                    addMessage(data.name, data.text);
                }
            };
            
            socket.onclose = function() {
                console.log('Disconnected from chat');
                updateStatus('Disconnected');
                addMessage('', 'Disconnected from chat', true);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('Error');
                addMessage('', 'Connection error', true);
            };
        }
        
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }
        
        function sendMessage() {
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addMessage('', 'Not connected to chat', true);
                return;
            }
            
            if (!messageInput.value.trim() || !nameInput.value.trim()) {
                addMessage('', 'Please enter both name and message', true);
                return;
            }
            
            const message = {
                type: 'chat.message',
                name: nameInput.value.trim(),
                text: messageInput.value.trim()
            };
            
            console.log('Sending:', message);
            socket.send(JSON.stringify(message));
            messageInput.value = '';
        }
        
        // Auto-connect on page load
        window.onload = function() {
            connect();
        };
        
        // Send message on Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
